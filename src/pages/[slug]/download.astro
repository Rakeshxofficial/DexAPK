---
export const prerender = false; // Server-side rendering for dynamic download pages

import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import DownloadTasksModal from '../../components/DownloadTasksModal.astro';
import { getAppBySlug, getRelatedApps, getAppDownloadTasksBySlug, getAppVersionsBySlug } from '../../lib/supabase.js';

// Get app slug from URL parameters
const { slug } = Astro.params;

// Fetch app data
let app = null;
if (slug) {
  app = await getAppBySlug(slug);
}

// If app not found or download page is disabled, redirect to app page
if (!app || app.disable_download_page) {
  return Astro.redirect(`/${slug}`, 301);
}

// Get related apps
let relatedApps = [];
try {
  relatedApps = await getRelatedApps(app.slug, app.category, 6);
} catch (error) {
  console.error('Error loading related apps:', error);
}

// Get download tasks for this app
let downloadTasks = [];
try {
  downloadTasks = await getAppDownloadTasksBySlug(app.slug);
} catch (error) {
  console.error('Error loading download tasks:', error);
}

// Get app versions for this app
let appVersions = [];
try {
  appVersions = await getAppVersionsBySlug(app.slug, 3);
  console.log('Loaded app versions:', appVersions);
} catch (error) {
  console.error('Error loading app versions:', error);
}

// SEO data with fallbacks
const seoTitle = `Download ${app.name} v${app.version} MOD APK - DexAPK`;
const seoDescription = `Download ${app.name} MOD APK v${app.version} with premium features unlocked. Fast and secure download.`;
const seoKeywords = `${app.name.toLowerCase()}, ${app.category.toLowerCase()}, mod apk, premium unlocked, android app, free download`;
const seoFeaturedImage = app.seo_featured_image || app.icon || '/favicon.svg';
const canonicalUrl = `https://dexapk.com/${app.slug}/download`;

// Prepare SEO data for Layout
const seoData = {
  title: seoTitle,
  description: seoDescription,
  keywords: seoKeywords,
  canonicalUrl: canonicalUrl,
  featuredImage: seoFeaturedImage,
  appName: app.name,
  appVersion: app.version,
  appCategory: app.category,
  appRating: app.rating,
  appVotes: app.votes,
  appPublisher: app.publisher,
  appSize: app.size,
  lastUpdated: app.last_updated,
  type: 'product'
};

// Get MOD features as a string
const modFeatures = app.mod_info && app.mod_info.length > 0 
  ? app.mod_info[0] 
  : 'Premium Unlocked';

// Generate auto-tutorial based on app name
function generateTutorial(appName) {
  return [
    `Download the ${appName} MOD APK file from the download button above.`,
    `Before installing, make sure to enable "Unknown Sources" in your device settings.`,
    `Locate the downloaded APK file in your device's Downloads folder.`,
    `Tap on the APK file to begin the installation process.`,
    `Follow the on-screen prompts to complete the installation.`,
    `Once installed, open ${appName} and enjoy all premium features unlocked!`
  ];
}

const tutorialSteps = generateTutorial(app.name);

// Generate installation FAQs
const installationFAQs = [
  {
    question: `Why does Google Play Protect show a warning when installing ${app.name}?`,
    answer: `Google Play Protect often flags modified APKs because they're not from the official Play Store. This is normal and doesn't mean the app is harmful. You can safely tap "Install Anyway" to proceed with installation.`
  },
  {
    question: `Do I need to uninstall the original ${app.name} first?`,
    answer: `Yes, it's recommended to uninstall the original version before installing the MOD APK to avoid conflicts and ensure all features work properly.`
  },
  {
    question: `Why is the ${app.name} MOD APK not installing on my device?`,
    answer: `This could be due to several reasons: 1) Insufficient storage space, 2) Incompatible Android version (this MOD requires ${app.requirements}), 3) Corrupted download file, or 4) Security settings blocking installation. Try clearing space, checking compatibility, re-downloading, or reviewing your security settings.`
  },
  {
    question: `Is it safe to use ${app.name} MOD APK?`,
    answer: `All MOD APKs on DexAPK are thoroughly scanned for malware and viruses before being made available. However, as with any modified application, use at your own discretion. We recommend using a reliable antivirus app on your device.`
  },
  {
    question: `Will I get banned for using ${app.name} MOD APK?`,
    answer: `For single-player apps and offline features, there's minimal risk. However, for online services or multiplayer games, there's a possibility of account suspension if the service detects modified clients. Consider using a secondary account for online features.`
  },
  {
    question: `How do I update ${app.name} MOD APK when a new version is available?`,
    answer: `You'll need to manually download and install the latest version from DexAPK. We regularly update our MODs with the newest versions and features. Check back often or subscribe to our Telegram channel for updates.`
  }
];

// Prepare versions for display
// Current version is always shown first
const currentVersion = app ? {
  id: 'current',
  version: `v${app.version}`,
  size: app.size || '0 MB',
  mod_info: app.mod_info && app.mod_info.length > 0 ? app.mod_info[0] : 'Premium Unlocked',
  release_date: app.updated_at || new Date().toISOString(),
  download_url: app.download_url || '#',
  is_active: true,
  isCurrent: true
} : null;

// Filter out any versions that match the current version
const previousVersions = appVersions.filter(v => 
  v.version !== `v${app.version}` && 
  v.version !== app.version
);

// Combine current version with previous versions
const allVersions = currentVersion ? [currentVersion, ...previousVersions] : [];
---

<Layout seoData={seoData}>
  <Header />
  
  <main class="min-h-screen bg-gray-50 dark:bg-gray-900">
    
    <!-- Breadcrumbs -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 overflow-hidden" aria-label="Breadcrumb">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="overflow-x-auto scrollbar-hide py-4">
          <ol class="flex items-center space-x-2 text-sm whitespace-nowrap" role="list">
            <li>
              <a href="/" class="inline-flex items-center justify-center min-w-[44px] min-h-[44px] text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" aria-label="Go to homepage">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                <span class="sr-only">Home</span>
              </a>
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <a href={`/${app.slug}`} class="inline-flex items-center justify-center min-w-[44px] min-h-[44px] ml-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                {app.name}
              </a>
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="ml-2 font-medium text-gray-900 dark:text-white" aria-current="page">Download</span>
            </li>
          </ol>
        </div>
      </div>
    </nav>

    <!-- Download Header -->
    <section class="bg-gradient-to-r from-blue-600 to-purple-600 py-12">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="flex items-center justify-center mb-6">
          <div class="w-24 h-24 sm:w-32 sm:h-32 bg-white dark:bg-gray-800 rounded-3xl shadow-lg flex items-center justify-center overflow-hidden">
            {app.icon ? (
              <img 
                src={app.icon} 
                alt={`${app.name} icon`}
                class="w-full h-full object-cover"
                width="128"
                height="128"
                loading="eager"
              />
            ) : (
              <svg class="w-16 h-16 sm:w-20 sm:h-20 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
            )}
          </div>
        </div>
        
        <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">
          {app.name} MOD APK v{app.version}
        </h1>
        <p class="text-xl text-blue-100 mb-8">
          {modFeatures}
        </p>
        
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
          <a
            href={app.download_url || '#'}
            target="_blank"
            id="download-button"
            data-app-slug={app.slug}
            class="inline-flex items-center px-8 py-4 bg-black dark:bg-white text-white dark:text-black text-lg font-semibold rounded-2xl hover:bg-gray-800 dark:hover:bg-gray-100 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 cursor-pointer min-w-[200px] justify-center"
            aria-label={`Download ${app.name} v${app.version} MOD APK`}
            onclick="openDownloadTasksModal(event)"
          >
            <svg class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
            </svg>
            Download Now
          </a>
          
          <div class="flex items-center text-white bg-white/20 px-4 py-2 rounded-xl backdrop-blur-sm">
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
            </svg>
            <span>{app.size}</span>
            <span class="mx-2">•</span>
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span>{app.last_updated}</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Import Download Tasks Modal -->
    <DownloadTasksModal appSlug={app.slug} />

    <!-- Thank You Section -->
    <section class="py-12 bg-white dark:bg-gray-800">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          Thanks for downloading {app.name}!
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">
          Your download should start automatically. If it doesn't, click the download button above.
          We've included some helpful information below to get you started with {app.name}.
        </p>
      </div>
    </section>

    <!-- Latest Versions Section -->
    <section class="py-12 bg-gray-50 dark:bg-gray-900">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          {previousVersions.length > 0 ? 'Latest Versions' : 'Current Version'}
        </h2>
        
        <div class="space-y-4">
          {allVersions.map((version) => (
            <div class={`bg-white dark:bg-gray-800 rounded-xl shadow-sm border ${version.isCurrent ? 'border-blue-300 dark:border-blue-700' : 'border-gray-200 dark:border-gray-700'} overflow-hidden`}>
              <div class="p-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <div>
                    <div class="flex items-center">
                      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        {app.name} {version.version}
                      </h3>
                      {version.isCurrent && (
                        <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                          Latest
                        </span>
                      )}
                    </div>
                    <div class="mt-1 flex items-center text-sm text-gray-500 dark:text-gray-400">
                      <span>{version.size}</span>
                      <span class="mx-2">•</span>
                      <span>{new Date(version.release_date).toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' })}</span>
                    </div>
                    <div class="mt-2">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                        {version.mod_info}
                      </span>
                    </div>
                  </div>
                  
                  <div>
                    <a
                      href={version.download_url || '#'}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200"
                      aria-label={`Download ${app.name} ${version.version}`}
                    >
                      <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                      </svg>
                      Download
                    </a>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- Tutorial Section -->
    <section class="py-12 bg-white dark:bg-gray-800">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          How to Install {app.name}
        </h2>
        
        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
          <ol class="space-y-6">
            {tutorialSteps.map((step, index) => (
              <li class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-4 font-bold">
                  {index + 1}
                </div>
                <p class="text-gray-700 dark:text-gray-300 pt-1">{step}</p>
              </li>
            ))}
          </ol>
        </div>
      </div>
    </section>

    <!-- Important Notes Section -->
    <section class="py-12 bg-gray-50 dark:bg-gray-900">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          Important Notes
        </h2>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <ul class="space-y-4">
            <li class="flex items-start">
              <svg class="w-6 h-6 text-yellow-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
              <p class="text-gray-700 dark:text-gray-300">
                <strong>Google Play Protect Warning:</strong> Google tries to block apps that aren't from the Play Store. To install {app.name} MOD APK, you'll need to tap "Install Anyway" when prompted. This is normal and doesn't mean the app is harmful.
              </p>
            </li>
            <li class="flex items-start">
              <svg class="w-6 h-6 text-yellow-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
              </svg>
              <p class="text-gray-700 dark:text-gray-300">
                <strong>CPU/GPU Compatibility:</strong> This MOD APK is optimized for most Android devices. However, some features may work differently depending on your device's processor architecture. For best performance, ensure your device meets the requirements: {app.requirements}.
              </p>
            </li>
            <li class="flex items-start">
              <svg class="w-6 h-6 text-yellow-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <p class="text-gray-700 dark:text-gray-300">
                <strong>Original App:</strong> It's recommended to uninstall the original version of {app.name} before installing this MOD APK to avoid conflicts and ensure all features work properly.
              </p>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Installation Notes Section -->
    <section class="py-12 bg-white dark:bg-gray-800">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          Installation Notes
        </h2>
        
        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
          <div class="space-y-6">
            <div>
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Step-by-Step Installation</h3>
              <ol class="list-decimal list-inside space-y-3 text-gray-700 dark:text-gray-300">
                <li>Download the {app.name} MOD APK file using the download button above</li>
                <li>Go to <strong>Settings</strong> on your Android device</li>
                <li>Navigate to <strong>Security</strong> or <strong>Privacy</strong></li>
                <li>Find and enable <strong>Unknown Sources</strong> or <strong>Install unknown apps</strong></li>
                <li>On newer Android versions (8.0+), you may need to enable it per app (for your browser or file manager)</li>
                <li>Open your device's <strong>File Manager</strong> or <strong>Downloads</strong> app</li>
                <li>Locate the {app.name} APK file you just downloaded</li>
                <li>Tap on the APK file to start the installation process</li>
                <li>Review the permissions requested by the app</li>
                <li>Tap <strong>Install</strong> to proceed with installation</li>
                <li>Wait for the installation to complete</li>
                <li>Tap <strong>Open</strong> to launch {app.name}</li>
              </ol>
            </div>
            
            <div>
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Troubleshooting Common Issues</h3>
              <div class="space-y-4">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg">
                  <h4 class="font-medium text-gray-900 dark:text-white mb-2">"App not installed" Error</h4>
                  <ul class="list-disc list-inside text-gray-700 dark:text-gray-300 text-sm">
                    <li>Ensure you have enough storage space on your device</li>
                    <li>Uninstall any previous version of the app first</li>
                    <li>Try downloading the APK file again</li>
                    <li>Restart your device and try installing again</li>
                  </ul>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg">
                  <h4 class="font-medium text-gray-900 dark:text-white mb-2">"Parse Error" or "There was a problem parsing the package"</h4>
                  <ul class="list-disc list-inside text-gray-700 dark:text-gray-300 text-sm">
                    <li>The APK file might be corrupted - try downloading again</li>
                    <li>Ensure your device meets the minimum Android version requirement: {app.requirements}</li>
                    <li>Check if the APK is compatible with your device architecture (ARM, x86, etc.)</li>
                  </ul>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg">
                  <h4 class="font-medium text-gray-900 dark:text-white mb-2">"Install blocked" or Security Warning</h4>
                  <ul class="list-disc list-inside text-gray-700 dark:text-gray-300 text-sm">
                    <li>Make sure you've enabled installation from unknown sources</li>
                    <li>On newer Android versions, grant permission to your browser or file manager to install apps</li>
                    <li>Temporarily disable any antivirus apps that might be blocking installation</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQs Section -->
    <section class="py-12 bg-gray-50 dark:bg-gray-900">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          Frequently Asked Questions
        </h2>
        
        <div class="space-y-4">
          {installationFAQs.map((faq) => (
            <details class="group bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
              <summary class="cursor-pointer p-6 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white group-open:text-blue-600 dark:group-open:text-blue-400 transition-colors duration-200">
                  {faq.question}
                </h3>
                <svg class="w-6 h-6 text-gray-400 group-open:text-blue-500 group-open:rotate-180 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="px-6 pb-6 text-gray-700 dark:text-gray-300">
                {faq.answer}
              </div>
            </details>
          ))}
        </div>
      </div>
    </section>

    <!-- Related Posts Section -->
    <section class="py-12 bg-white dark:bg-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">
          Related Apps
        </h2>
        
        <div class="relative px-12">
          <!-- Scrollable Container -->
          <div class="overflow-x-auto pb-4 scrollbar-hide">
            <div class="flex space-x-4 min-w-max">
              {relatedApps.map((relatedApp) => (
                <div class="w-64 flex-shrink-0">
                  <a 
                    href={`/${relatedApp.slug}`} 
                    class="block bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow duration-200 h-full"
                  >
                    <div class="p-4">
                      <div class="flex items-center mb-3">
                        <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-xl flex items-center justify-center overflow-hidden mr-3">
                          {relatedApp.icon ? (
                            <img 
                              src={relatedApp.icon} 
                              alt={`${relatedApp.name} icon`}
                              class="w-full h-full object-cover"
                              loading="lazy"
                            />
                          ) : (
                            <svg class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                          )}
                        </div>
                        <div>
                          <h3 class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                            {relatedApp.name}
                          </h3>
                          <p class="text-xs text-blue-600 dark:text-blue-400">
                            {relatedApp.category}
                          </p>
                        </div>
                      </div>
                      <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <div class="flex items-center">
                          <svg class="w-3 h-3 text-yellow-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                          </svg>
                          <span>{relatedApp.rating}</span>
                        </div>
                        <span>{relatedApp.size}</span>
                      </div>
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </div>
          
          <!-- Scroll Indicators -->
          <div class="absolute left-0 top-1/2 transform -translate-y-1/2 z-10">
            <button 
              id="scroll-left" 
              class="bg-white dark:bg-gray-800 rounded-full p-2 shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
              aria-label="Scroll left"
            >
              <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
          </div>
          <div class="absolute right-0 top-1/2 transform -translate-y-1/2 z-10">
            <button 
              id="scroll-right" 
              class="bg-white dark:bg-gray-800 rounded-full p-2 shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
              aria-label="Scroll right"
            >
              <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </section>

  </main>
  
  <Footer />
</Layout>

<script>
  // Function to open the download tasks modal
  window.openDownloadTasksModal = function(event) {
    event.preventDefault();
    
    // Get the app slug from the button's data attribute
    const appSlug = event.currentTarget.getAttribute('data-app-slug');
    
    // Set the app slug in the modal's hidden input
    const modalAppSlugInput = document.getElementById('modal-app-slug');
    if (modalAppSlugInput) {
      modalAppSlugInput.value = appSlug;
    }
    
    // Get the modal element
    const modal = document.getElementById('download-tasks-modal');
    if (!modal) {
      console.error('Download tasks modal not found');
      return;
    }
    
    // Show the modal
    requestAnimationFrame(() => {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    });
    
    // Focus the close button for accessibility
    const closeBtn = document.getElementById('close-download-tasks');
    closeBtn?.focus();
    
    // Initialize the modal with tasks
    if (typeof initializeDownloadTasksModal === 'function') {
      initializeDownloadTasksModal(appSlug);
    }
  };

  // Horizontal scrolling for related apps
  document.addEventListener('DOMContentLoaded', function() {
    // Use let instead of const for variables that will be reused
    let scrollContainer, scrollLeftBtn, scrollRightBtn;
    
    // Use requestIdleCallback to defer non-critical initialization
    (window.requestIdleCallback || window.setTimeout)(() => {
      scrollContainer = document.querySelector('.overflow-x-auto');
      scrollLeftBtn = document.getElementById('scroll-left');
      scrollRightBtn = document.getElementById('scroll-right');
      
      if (scrollContainer && scrollLeftBtn && scrollRightBtn) {
        // Initially hide left button if at start
        updateScrollButtons();
        
        scrollLeftBtn.addEventListener('click', function() {
          scrollContainer.scrollBy({ left: -300, behavior: 'smooth' });
          // Announce to screen readers
          announceToScreenReader('Scrolled left');
        });
        
        scrollRightBtn.addEventListener('click', function() {
          scrollContainer.scrollBy({ left: 300, behavior: 'smooth' });
          // Announce to screen readers
          announceToScreenReader('Scrolled right');
        });
        
        // Use passive event listener for better performance
        scrollContainer.addEventListener('scroll', updateScrollButtons, { passive: true });
        
        // Update on resize with debounce
        let resizeTimer;
        window.addEventListener('resize', function() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(updateScrollButtons, 100);
        }, { passive: true });
      }
      
      function updateScrollButtons() {
        // Use requestAnimationFrame to batch DOM updates
        requestAnimationFrame(() => {
          // Show/hide left button based on scroll position
          if (scrollContainer.scrollLeft <= 0) {
            scrollLeftBtn.classList.add('opacity-0', 'pointer-events-none');
          } else {
            scrollLeftBtn.classList.remove('opacity-0', 'pointer-events-none');
          }
          
          // Show/hide right button based on scroll position
          if (scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 10) {
            scrollRightBtn.classList.add('opacity-0', 'pointer-events-none');
          } else {
            scrollRightBtn.classList.remove('opacity-0', 'pointer-events-none');
          }
        });
      }
      
      // Function for screen reader announcements
      function announceToScreenReader(message) {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = message;
        
        document.body.appendChild(announcement);
        setTimeout(() => {
          document.body.removeChild(announcement);
        }, 1000);
      }
    }, { timeout: 1000 });
  });
</script>

<style>
  /* Hide scrollbar for Chrome, Safari and Opera */
  .relative {
    position: relative;
  }
  
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  /* Hide scrollbar for IE, Edge and Firefox */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
  
  /* Add will-change for smoother animations */
  #download-button {
    will-change: transform;
  }
  
  /* Optimize animations for reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .transition-all, .transition-transform, .transition-colors {
      transition: none !important;
    }
  }
  
  /* Screen reader only class */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>

<style is:global>
  /* Ensure scroll buttons don't overlap content */
  #scroll-left, #scroll-right {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  /* Add a semi-transparent background to ensure button visibility */
  #scroll-left {
    background-color: rgba(255, 255, 255, 0.9);
    left: -4px;
  }
  
  #scroll-right {
    background-color: rgba(255, 255, 255, 0.9);
    right: -4px;
  }
  
  /* Dark mode support */
  .dark #scroll-left, .dark #scroll-right {
    background-color: rgba(31, 41, 55, 0.9);
  }
</style>