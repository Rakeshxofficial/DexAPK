---
export const prerender = true;

import { getAllApps, getRelatedApps } from '../../lib/supabase.js';

export async function getStaticPaths() {
  try {
    const apps = await getAllApps();
    return apps.map(app => ({
      params: { slug: app.slug },
      props: { app }
    }));
  } catch (error) {
    console.error('Error generating static paths for AMP pages:', error);
    return [];
  }
}

const { slug } = Astro.params;
const { app } = Astro.props;

// If app not found, return 404
if (!app) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

// Get related apps
let relatedApps = [];
try {
  relatedApps = await getRelatedApps(app.slug, app.category, 3);
} catch (error) {
  console.error('Error loading related apps for AMP:', error);
}

// Function to convert markdown to AMP-compatible HTML
function markdownToAmpHtml(markdown) {
  if (!markdown) return '';
  
  const lines = markdown.split('\n');
  let html = '';
  let inCodeBlock = false;
  let inList = false;
  let listType = '';
  let inTable = false;
  
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i];
    
    // Handle code blocks
    if (line.startsWith('```')) {
      inCodeBlock = !inCodeBlock;
      if (inCodeBlock) {
        html += '<pre style="background: #f3f4f6; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 16px 0;"><code>';
      } else {
        html += '</code></pre>';
      }
      continue;
    }
    
    if (inCodeBlock) {
      html += escapeHtml(line) + '\n';
      continue;
    }
    
    // Handle headings
    const headingMatch = line.match(/^(#{1,6})\s+(.+)$/);
    if (headingMatch) {
      const level = headingMatch[1].length;
      const text = formatInlineMarkdown(headingMatch[2]);
      html += `<h${level} style="font-size: ${level === 1 ? '28px' : level === 2 ? '24px' : level === 3 ? '20px' : '18px'}; font-weight: bold; margin: 24px 0 16px 0; color: #1f2937;">${text}</h${level}>`;
      continue;
    }
    
    // Handle horizontal rules
    if (line.match(/^---+$/)) {
      html += '<hr style="border: none; border-top: 1px solid #e5e7eb; margin: 24px 0;">';
      continue;
    }
    
    // Handle tables
    if (line.includes('|')) {
      const cells = line.split('|').map(cell => cell.trim()).filter(Boolean);
      
      if (cells.length === 0) continue;
      
      if (cells.length >= 1) {
        const nextLine = lines[i + 1];
        
        if (!inTable && nextLine && nextLine.includes('|') && nextLine.includes('---')) {
          inTable = true;
          html += '<div style="overflow-x: auto; margin: 16px 0;"><table style="min-width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb;"><thead style="background: #f9fafb;"><tr>';
          cells.forEach(cell => {
            html += `<th style="padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">${formatInlineMarkdown(cell)}</th>`;
          });
          html += '</tr></thead><tbody>';
          i++; // Skip separator line
          continue;
        } else if (inTable) {
          html += '<tr>';
          cells.forEach(cell => {
            html += `<td style="padding: 12px 16px; font-size: 14px; color: #1f2937; border-bottom: 1px solid #e5e7eb;">${formatInlineMarkdown(cell)}</td>`;
          });
          html += '</tr>';
          continue;
        }
      }
    }
    
    if (inTable && !line.includes('|')) {
      html += '</tbody></table></div>';
      inTable = false;
    }
    
    // Handle lists
    const listMatch = line.match(/^(\s*)([-*+]|\d+\.)\s+(.+)$/);
    if (listMatch) {
      const marker = listMatch[2];
      const text = listMatch[3];
      const isOrdered = /^\d+\./.test(marker);
      
      if (!inList) {
        inList = true;
        listType = isOrdered ? 'ol' : 'ul';
        html += `<${listType} style="margin: 16px 0; padding-left: 24px;">`;
      }
      
      html += `<li style="margin: 8px 0;">${formatInlineMarkdown(text)}</li>`;
      continue;
    } else if (inList) {
      inList = false;
      html += `</${listType}>`;
    }
    
    // Handle blockquotes
    if (line.startsWith('> ')) {
      html += `<blockquote style="border-left: 4px solid #3b82f6; padding-left: 16px; margin: 16px 0; font-style: italic; color: #6b7280;">${formatInlineMarkdown(line.slice(2))}</blockquote>`;
      continue;
    }
    
    // Handle paragraphs
    if (line.trim()) {
      html += `<p style="margin: 16px 0; line-height: 1.6; color: #374151;">${formatInlineMarkdown(line)}</p>`;
    }
  }
  
  // Close any open lists
  if (inList) {
    html += `</${listType}>`;
  }
  if (inTable) {
    html += '</tbody></table></div>';
  }
  
  return html;
}

// Helper function to format inline markdown
function formatInlineMarkdown(text) {
  return text
    // Bold
    .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600;">$1</strong>')
    // Italic
    .replace(/\*(.*?)\*/g, '<em style="font-style: italic;">$1</em>')
    // Code
    .replace(/`(.*?)`/g, '<code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 14px;">$1</code>')
    // Links (AMP-safe)
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color: #3b82f6; text-decoration: underline;">$1</a>')
    // Strikethrough
    .replace(/~~(.*?)~~/g, '<del style="text-decoration: line-through;">$1</del>');
}

// Helper function to escape HTML
function escapeHtml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// Get article content (use existing or default)
const articleContent = app.article_content || `# Introduction

${app.description}

## Key Features

${app.features && app.features.length > 0 ? app.features.map(feature => `- ${feature}`).join('\n') : '- Premium features unlocked\n- Enhanced user experience\n- No limitations'}

## What's New in v${app.version}

- Enhanced performance and stability
- Improved user interface
- Bug fixes and optimizations
- New premium features added
- Better compatibility with latest Android versions

## Installation Guide

1. **Download the APK** - Click the download button to get the ${app.name} MOD APK file.
2. **Enable Unknown Sources** - Go to Settings > Security > Unknown Sources and enable it.
3. **Install the APK** - Locate the downloaded file and tap to install.
4. **Enjoy Premium Features** - Open the app and enjoy all premium features unlocked!

## Conclusion

${app.name} MOD APK offers an exceptional experience with all premium features unlocked for free. Download now and experience the full potential of ${app.name} on your Android device.`;

// AMP-specific meta data
// Use SEO data from Admin Panel with proper fallbacks
const ampTitle = app.seo_title || `${app.name} v${app.version} MOD APK - Premium Features Unlocked`;
const ampDescription = app.seo_description || `Download ${app.name} MOD APK v${app.version} with premium features unlocked. ${app.description.substring(0, 150)}...`;
const ampKeywords = app.seo_keywords || `${app.name.toLowerCase()}, ${app.category.toLowerCase()}, mod apk, premium unlocked, android app, free download`;
const ampFeaturedImage = app.seo_featured_image || app.icon || 'https://dexapk.com/web-app-manifest-512x512.png';
const canonicalUrl = `https://dexapk.com/${app.slug}`;
const ampUrl = `https://dexapk.com/${app.slug}/amp`;

// Custom H1 title from Admin Panel
const customH1Title = app.custom_h1_title || `${app.name} v${app.version} MOD APK`;

// Function to escape HTML for safe rendering
function escapeHtmlAttribute(text) {
  if (!text) return '';
  return text
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// Disable Astro's head injection for this page
const response = new Response(`<!doctype html>
<html ⚡ lang="en">
<head>
  <meta charset="utf-8">
  <script async src="https://cdn.ampproject.org/v0.js"></script>
  <script async custom-element="amp-carousel" src="https://cdn.ampproject.org/v0/amp-carousel-0.1.js"></script>
  <script async custom-element="amp-sidebar" src="https://cdn.ampproject.org/v0/amp-sidebar-0.1.js"></script>
  
  <title>${ampTitle}</title>
  <link rel="canonical" href="${canonicalUrl}">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
  
  <!-- Meta Tags -->
  <meta name="description" content="${escapeHtmlAttribute(ampDescription)}">
  <meta name="keywords" content="${escapeHtmlAttribute(ampKeywords)}">
  <meta name="author" content="DexAPK">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph -->
  <meta property="og:title" content="${escapeHtmlAttribute(ampTitle)}">
  <meta property="og:description" content="${escapeHtmlAttribute(ampDescription)}">
  <meta property="og:image" content="${escapeHtmlAttribute(ampFeaturedImage)}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="${escapeHtmlAttribute(ampTitle)}">
  <meta property="og:url" content="${ampUrl}">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="DexAPK">
  <meta property="og:locale" content="en_US">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="${escapeHtmlAttribute(ampTitle)}">
  <meta name="twitter:description" content="${escapeHtmlAttribute(ampDescription)}">
  <meta name="twitter:image" content="${escapeHtmlAttribute(ampFeaturedImage)}">
  <meta name="twitter:image:alt" content="${escapeHtmlAttribute(ampTitle)}">
  <meta name="twitter:site" content="@dexapk">
  <meta name="twitter:creator" content="@dexapk">
  
  <!-- Additional SEO Meta Tags -->
  <meta name="application-name" content="${escapeHtmlAttribute(app.name)}">
  <meta name="theme-color" content="#3b82f6">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="${escapeHtmlAttribute(app.name)}">
  
   <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/web-app-manifest-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/web-app-manifest-512×512-new.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="mask-icon" href="/favicon-96x96.png" color="#3b82f6" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" sizes="16x16 32x32" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <!-- Canonical and AMP relationship -->
  <link rel="amphtml" href="${ampUrl}">
  
  <!-- AMP Boilerplate - MANDATORY -->
  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
  
  <!-- AMP Custom Styles -->
  <style amp-custom>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9fafb;
      color: #1f2937;
      line-height: 1.6;
    }
    
    /* Header Styles */
    .amp-header {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    /* Desktop Navigation - Hidden on Mobile */
    .nav-menu {
      display: none;
      align-items: center;
      gap: 24px;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    
    .nav-link {
      color: #374151;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .nav-link:hover {
      color: #3b82f6;
      background-color: #f3f4f6;
    }
    
    /* Mobile Menu Button - Visible on Mobile */
    .mobile-menu-button {
      display: flex;
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 6px;
      min-width: 44px;
      min-height: 44px;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    
    .mobile-menu-button:hover {
      background-color: #f3f4f6;
    }
    
    .mobile-menu-button svg {
      width: 24px;
      height: 24px;
      stroke: #374151;
      stroke-width: 2;
      fill: none;
    }
    
    /* AMP Sidebar Styles */
    .sidebar {
      background: white;
      width: 280px;
      padding: 0;
      height: 100vh;
      overflow-y: auto;
    }
    
    .sidebar-header {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .sidebar-header h3 {
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: bold;
    }
    
    .sidebar-header p {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .sidebar-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .sidebar-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .sidebar-close svg {
      width: 16px;
      height: 16px;
      stroke: white;
      stroke-width: 2;
      fill: none;
    }
    
    .sidebar-nav {
      padding: 20px 0;
    }
    
    .sidebar-nav a {
      display: block;
      padding: 16px 20px;
      color: #374151;
      text-decoration: none;
      font-weight: 500;
      border-bottom: 1px solid #f3f4f6;
      transition: all 0.2s ease;
      font-size: 16px;
    }
    
    .sidebar-nav a:hover {
      background-color: #f3f4f6;
      color: #3b82f6;
    }
    
    /* Responsive Breakpoints */
    @media (min-width: 769px) {
      .nav-menu {
        display: flex;
      }
      
      .mobile-menu-button {
        display: none;
      }
      
      .header-container {
        justify-content: space-between;
      }
    }
    
    @media (max-width: 768px) {
      .nav-menu {
        display: none;
      }
      
      .mobile-menu-button {
        display: flex;
      }
      
      .header-container {
        justify-content: space-between;
      }
    }
    
    @media (max-width: 480px) {
      .amp-header {
        padding: 8px 12px;
      }
      
      .mobile-menu-button {
        min-width: 40px;
        min-height: 40px;
        padding: 6px;
      }
      
      .mobile-menu-button svg {
        width: 20px;
        height: 20px;
      }
    }</parameter>
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }
    
    .header {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      padding: 32px 16px;
      text-align: center;
      margin-bottom: 24px;
    }
    
    .app-icon {
      width: 96px;
      height: 96px;
      border-radius: 24px;
      margin: 0 auto 16px;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .app-title {
      font-size: 28px;
      font-weight: bold;
      margin: 0 0 8px;
    }
    
    .app-version {
      font-size: 18px;
      opacity: 0.9;
      margin: 0 0 16px;
    }
    
    .app-description {
      font-size: 16px;
      opacity: 0.95;
      margin: 0 0 16px;
      line-height: 1.5;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .download-btn {
      display: inline-block;
      background: #000;
      color: white;
      padding: 16px 32px;
      border-radius: 16px;
      text-decoration: none;
      font-weight: 600;
      font-size: 18px;
      margin-top: 16px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: bold;
      margin: 0 0 16px;
      color: #1f2937;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .info-item {
      background: #f3f4f6;
      padding: 16px;
      border-radius: 12px;
    }
    
    .info-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .info-value {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .feature-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .feature-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .feature-item:last-child {
      border-bottom: none;
    }
    
    .feature-icon {
      width: 20px;
      height: 20px;
      background: #10b981;
      border-radius: 50%;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .rating {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 16px 0;
    }
    
    .star {
      width: 24px;
      height: 24px;
      margin: 0 2px;
    }
    
    .star.filled {
      color: #fbbf24;
    }
    
    .star.empty {
      color: #d1d5db;
    }
    
    .rating-text {
      margin-left: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .screenshots {
      margin: 24px 0;
    }
    
    .related-apps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }
    
    .related-app {
      background: white;
      border-radius: 12px;
      padding: 16px;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .related-app-title {
      font-size: 16px;
      font-weight: 600;
      margin: 8px 0 4px;
      color: #1f2937;
    }
    
    .related-app-category {
      font-size: 14px;
      color: #6b7280;
    }
    
    /* Internal Link Styles */
    .info-value a {
      transition: color 0.2s ease;
    }
    
    .info-value a:hover {
      color: #1d4ed8;
      text-decoration: underline;
    }
    
    .related-app {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .related-app:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .footer {
      text-align: center;
      padding: 32px 16px;
      background: #1f2937;
      color: white;
      margin-top: 48px;
    }
    
    .footer-link {
      color: #60a5fa;
      text-decoration: none;
    }
    
    .article-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .article-content h1,
    .article-content h2,
    .article-content h3,
    .article-content h4,
    .article-content h5,
    .article-content h6 {
      color: #1f2937;
      margin-top: 24px;
      margin-bottom: 16px;
    }
    
    .article-content p {
      margin: 16px 0;
      line-height: 1.6;
      color: #374151;
    }
    
    .article-content ul,
    .article-content ol {
      margin: 16px 0;
      padding-left: 24px;
    }
    
    .article-content li {
      margin: 8px 0;
    }
    
    .article-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    
    .article-content pre {
      background: #f3f4f6;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 16px 0;
    }
    
    .article-content blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 16px;
      margin: 16px 0;
      font-style: italic;
      color: #6b7280;
    }
    
    .article-content a {
      color: #3b82f6;
      text-decoration: underline;
    }
    
    /* MOD Info Section Styles */
    .mod-info-container {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e2e8f0;
    }
    
    .mod-info-description {
      font-size: 16px;
      color: #475569;
      margin: 0 0 16px 0;
      font-weight: 500;
    }
    
    .feature-text {
      font-size: 15px;
      color: #334155;
      font-weight: 500;
    }
    
    .mod-info-notice {
      background: #dbeafe;
      border: 1px solid #93c5fd;
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 20px;
    }
    
    .mod-info-notice p {
      margin: 0;
      font-size: 14px;
      color: #1e40af;
      line-height: 1.4;
    }
    
    .mod-info-notice strong {
      font-weight: 600;
      color: #1e3a8a;
    }
    
    /* Mobile Responsive for MOD Info */
    @media (max-width: 640px) {
      .mod-info-container {
        padding: 16px;
        border-radius: 8px;
      }
      
      .mod-info-description {
        font-size: 15px;
      }
      
      .feature-text {
        font-size: 14px;
      }
      
      .mod-info-notice {
        padding: 10px 12px;
      }
      
      .mod-info-notice p {
        font-size: 13px;
      }
    }
    
    @media (max-width: 640px) {
      .app-title {
        font-size: 24px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .related-apps {
        grid-template-columns: 1fr;
      }
    }
  </style>
  
  <!-- Schema.org Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "${escapeHtmlAttribute(app.name)}",
    "applicationCategory": "MobileApplication",
    "applicationSubCategory": "${escapeHtmlAttribute(app.category)}",
    "operatingSystem": "Android",
    "softwareVersion": "${escapeHtmlAttribute(app.version)}",
    "fileSize": "${escapeHtmlAttribute(app.size)}",
    "description": "${escapeHtmlAttribute(app.description)}",
    "url": "${canonicalUrl}",
    "downloadUrl": "${escapeHtmlAttribute(app.download_url || '#')}",
    "datePublished": "${app.created_at || new Date().toISOString()}",
    "dateModified": "${app.updated_at || new Date().toISOString()}",
    "publisher": {
      "@type": "Organization",
      "name": "${escapeHtmlAttribute(app.publisher)}"
    },
    "author": {
      "@type": "Organization", 
      "name": "DexAPK",
      "url": "https://dexapk.com"
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "${app.rating}",
      "ratingCount": "${app.votes}",
      "bestRating": "5",
      "worstRating": "1"
    },
    "screenshot": ${app.screenshots && app.screenshots.length > 0 ? JSON.stringify(app.screenshots) : '[]'},
    "featureList": ${app.features && app.features.length > 0 ? JSON.stringify(app.features) : '[]'},
    "requirements": "${escapeHtmlAttribute(app.requirements)}",
    "installUrl": "${escapeHtmlAttribute(app.download_url || '#')}",
    "memoryRequirements": "${escapeHtmlAttribute(app.size)}",
    "storageRequirements": "${escapeHtmlAttribute(app.size)}"
  }
  </script>
  
  <!-- Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "DexAPK",
    "url": "https://dexapk.com",
    "logo": "https://dexapk.com/web-app-manifest-512x512.png",
    "description": "Premium MOD APKs for Android devices",
    "sameAs": [
      "https://t.me/dexapk_com",
      "https://twitter.com/dexapk"
    ]
  }
  </script>
  
  <!-- WebPage Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "${escapeHtmlAttribute(ampTitle)}",
    "description": "${escapeHtmlAttribute(ampDescription)}",
    "url": "${ampUrl}",
    "mainEntity": {
      "@type": "SoftwareApplication",
      "name": "${escapeHtmlAttribute(app.name)}"
    },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://dexapk.com"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Apps",
          "item": "https://dexapk.com/apps"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "${escapeHtmlAttribute(app.category)}",
          "item": "https://dexapk.com/categories/${app.category.toLowerCase()}"
        },
        {
          "@type": "ListItem",
          "position": 4,
          "name": "${escapeHtmlAttribute(app.name)}",
          "item": "${ampUrl}"
        }
      ]
    },
    "publisher": {
      "@type": "Organization",
      "name": "DexAPK"
    }
  }
  </script>
  
  <!-- Review Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Review",
    "itemReviewed": {
      "@type": "SoftwareApplication",
      "name": "${escapeHtmlAttribute(app.name)}",
      "applicationCategory": "MobileApplication",
      "operatingSystem": "Android"
    },
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": "${app.rating}",
      "bestRating": "5",
      "worstRating": "1"
    },
    "author": {
      "@type": "Organization",
      "name": "DexAPK"
    },
    "publisher": {
      "@type": "Organization",
      "name": "DexAPK"
    },
    "datePublished": "${app.created_at || new Date().toISOString()}",
    "reviewBody": "${escapeHtmlAttribute(app.description)}"
  }
  </script>
  
  <!-- Product Schema for MOD APK -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "${escapeHtmlAttribute(app.name)} MOD APK",
    "description": "${escapeHtmlAttribute(app.description)}",
    "image": "${escapeHtmlAttribute(app.icon || 'https://dexapk.com/web-app-manifest-512x512.png')}",
    "brand": {
      "@type": "Brand",
      "name": "${escapeHtmlAttribute(app.publisher)}"
    },
    "manufacturer": {
      "@type": "Organization",
      "name": "${escapeHtmlAttribute(app.publisher)}"
    },
    "model": "${escapeHtmlAttribute(app.version)}",
    "category": "${escapeHtmlAttribute(app.category)}",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock",
      "seller": {
        "@type": "Organization",
        "name": "DexAPK"
      }
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "${app.rating}",
      "ratingCount": "${app.votes}",
      "bestRating": "5",
      "worstRating": "1"
    },
    "additionalProperty": [
      {
        "@type": "PropertyValue",
        "name": "File Size",
        "value": "${escapeHtmlAttribute(app.size)}"
      },
      {
        "@type": "PropertyValue",
        "name": "Android Version",
        "value": "${escapeHtmlAttribute(app.requirements)}"
      },
      {
        "@type": "PropertyValue",
        "name": "Last Updated",
        "value": "${escapeHtmlAttribute(app.last_updated)}"
      }
    ]
  }
  </script>
</head>
<body>
  <!-- AMP Header -->
  <header class="amp-header">
    <div class="header-container">
      <!-- Logo -->
      <div class="logo-container">
        <a href="/">
          <amp-img 
            src="/dexapk-logo.svg" 
            alt="DexAPK Logo"
            width="45" 
            height="45"
            class="logo">
          </amp-img>
        </a>
      </div>
      
      <!-- Desktop Navigation (Hidden on Mobile) -->
      <nav class="nav-menu" role="navigation" aria-label="Main navigation">
        <a href="/" class="nav-link">Home</a>
        <a href="/apps" class="nav-link">Apps</a>
        <a href="/categories" class="nav-link">Categories</a>
        <a href="/trending" class="nav-link">Trending</a>
        <a href="/blog" class="nav-link">Blog</a>
        <a href="/about" class="nav-link">About</a>
      </nav>
      
      <!-- Mobile Menu Button (Visible on Mobile) -->
      <button class="mobile-menu-button" on="tap:sidebar1.toggle" aria-label="Open navigation menu">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- AMP Sidebar for Mobile Menu -->
  <amp-sidebar id="sidebar1" layout="nodisplay" side="left">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>DexAPK</h3>
        <p>Navigation Menu</p>
        <button class="sidebar-close" on="tap:sidebar1.close" aria-label="Close navigation menu">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <nav class="sidebar-nav" role="navigation" aria-label="Mobile navigation">
        <a href="/">🏠 Home</a>
        <a href="/apps">📱 All Apps</a>
        <a href="/categories">📂 Categories</a>
        <a href="/trending">🔥 Trending</a>
        <a href="/games">🎮 Games</a>
        <a href="/blog">📝 Blog</a>
        <a href="/about">ℹ️ About</a>
        <a href="/contact">📧 Contact</a>
        <a href="/help">❓ Help</a>
      </nav>
    </div>
  </amp-sidebar></parameter>

  <!-- Header -->
  <section class="header">
    <div class="container">
      <div class="app-icon">
        ${app.icon ? `
          <amp-img 
            src="${app.icon}" 
            alt="${app.name} icon"
            width="96" 
            height="96"
            layout="fixed">
          </amp-img>
        ` : `
          <svg width="48" height="48" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
          </svg>
        `}
      </div>
      
      <!-- H1 Title from Admin Panel with fallback -->
      <h1 class="app-title">${escapeHtmlAttribute(customH1Title)}</h1>
      
      <!-- Paragraph from Meta Description -->
      <p class="app-description">${escapeHtmlAttribute(ampDescription)}</p>
      
      <p class="app-version">Version ${app.version} • ${app.size}</p>
      
      <!-- Rating -->
      <div class="rating">
        ${[1,2,3,4,5].map(star => `
          <svg class="star ${star <= Math.floor(app.rating) ? 'filled' : 'empty'}" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
        `).join('')}
        <span class="rating-text">${app.rating} (${app.votes.toLocaleString()} votes)</span>
      </div>
      
      <!-- Download Button -->
      <a href="${app.download_url || '#'}" class="download-btn">
        Download MOD APK
      </a>
    </div>
  </section>

  <!-- Main Content -->
  <main class="container">
    
    <!-- App Information -->
    <div class="card">
      <h2 class="card-title">App Information</h2>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Category</div>
          <div class="info-value">
            <a href="/categories/${app.category.toLowerCase()}" style="color: #3b82f6; text-decoration: none; font-weight: 600;">
              ${app.category}
            </a>
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">Publisher</div>
          <div class="info-value">
            <a href="/publisher/${app.publisher.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '')}" style="color: #3b82f6; text-decoration: none; font-weight: 600;">
              ${app.publisher}
            </a>
          </div>
        </div>
        <div class="info-item">
          <div class="info-label">Requirements</div>
          <div class="info-value">${app.requirements}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Last Updated</div>
          <div class="info-value">${app.last_updated}</div>
        </div>
      </div>
    </div>

    ${app.mod_info && app.mod_info.length > 0 ? `
    <!-- MOD Info Section -->
    <div class="card">
      <h2 class="card-title">MOD Information</h2>
      <div class="mod-info-container">
        <p class="mod-info-description">This modified version includes the following enhancements:</p>
        <ul class="feature-list">
          ${app.mod_info.map(info => `
            <li class="feature-item">
              <div class="feature-icon"></div>
              <span class="feature-text">${escapeHtml(info)}</span>
            </li>
          `).join('')}
        </ul>
        <div class="mod-info-notice">
          <p><strong>Note:</strong> This is a modified version with premium features unlocked. All modifications are safe and tested.</p>
        </div>
      </div>
    </div>
    ` : ''}

    <!-- Description -->
    <!-- App Article Content -->
    <div class="article-content">
      ${markdownToAmpHtml(articleContent)}
    </div>

    ${app.screenshots && app.screenshots.length > 0 ? `
    <!-- Screenshots -->
    <div class="card">
      <h2 class="card-title">Screenshots</h2>
      <div class="screenshots">
        <amp-carousel width="400" height="300" layout="responsive" type="slides">
          ${app.screenshots.map((screenshot, index) => `
            <amp-img 
              src="${screenshot}" 
              alt="${app.name} screenshot ${index + 1}"
              width="400" 
              height="300"
              layout="responsive">
            </amp-img>
          `).join('')}
        </amp-carousel>
      </div>
    </div>
    ` : ''}

    ${relatedApps.length > 0 ? `
    <!-- Related Apps -->
    <div class="card">
      <h2 class="card-title">Related Apps</h2>
      <div class="related-apps">
        ${relatedApps.map(relatedApp => `
          <a href="/${relatedApp.slug}" class="related-app">
            ${relatedApp.icon ? `
              <amp-img 
                src="${relatedApp.icon}" 
                alt="${relatedApp.name} icon"
                width="48" 
                height="48"
                layout="fixed">
              </amp-img>
            ` : ''}
            <div class="related-app-title">${relatedApp.name}</div>
            <div class="related-app-category">${relatedApp.category}</div>
          </a>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <!-- Download Section -->
    <div class="card">
      <h2 class="card-title">Download ${app.name} MOD APK</h2>
      <p>Get the latest version with premium features unlocked</p>
      <a href="${app.download_url || '#'}" class="download-btn">
        Download v${app.version}
      </a>
    </div>

  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 DexAPK. All rights reserved.</p>
      <p>
        <a href="/" class="footer-link">Home</a> • 
        <a href="/apps" class="footer-link">All Apps</a> • 
        <a href="/categories" class="footer-link">Categories</a> • 
        <a href="/trending" class="footer-link">Trending</a> • 
        <a href="/blog" class="footer-link">Blog</a> • 
        <a href="/about" class="footer-link">About</a> • 
        <a href="/contact" class="footer-link">Contact</a>
      </p>
      <p>
        <a href="${canonicalUrl}" class="footer-link">View Full Version</a>
      </p>
    </div>
  </footer>
</body>
</html>`, {
  headers: {
    'Content-Type': 'text/html; charset=utf-8',
    'Cache-Control': 'public, max-age=3600'
  }
});

return response;
---