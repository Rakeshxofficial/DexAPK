---
export const prerender = true;

import { getAllApps, getAppBySlug, getRelatedApps } from '../../lib/supabase.js';

export async function getStaticPaths() {
  try {
    const apps = await getAllApps();
    return apps.map(app => ({
      params: { slug: app.slug },
      props: { app }
    }));
  } catch (error) {
    console.error('Error generating static paths for AMP:', error);
    return [];
  }
}

const { slug } = Astro.params;
const { app } = Astro.props;

// If app not found, return 404
if (!app) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

// Get related apps
let relatedApps = [];
try {
  relatedApps = await getRelatedApps(app.slug, app.category, 3);
} catch (error) {
  console.error('Error loading related apps:', error);
}

// SEO data
const seoTitle = `${app.name} v${app.version} MOD APK - Premium Features Unlocked`;
const seoDescription = `Download ${app.name} MOD APK v${app.version} with premium features unlocked. ${app.description.substring(0, 100)}...`;
const canonicalUrl = `https://dexapk.com/${app.slug}`;
const ampUrl = `https://dexapk.com/${app.slug}/amp`;

// Simple markdown to HTML converter for AMP
function markdownToHtml(markdown) {
  if (!markdown) return '';
  
  let html = markdown
    // Headers
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // Bold
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // Italic
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // Code
    .replace(/`(.*?)`/g, '<code>$1</code>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
    // Line breaks
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>');
  
  // Wrap in paragraphs
  html = '<p>' + html + '</p>';
  
  // Clean up empty paragraphs
  html = html.replace(/<p><\/p>/g, '');
  
  return html;
}

const articleContent = app.article_content || `${app.description}

## Key Features

${app.features && app.features.length > 0 ? app.features.map(feature => `- ${feature}`).join('\n') : '- Premium features unlocked\n- Enhanced user experience'}

## Installation Guide

1. Download the APK file
2. Enable Unknown Sources in Android settings
3. Install the APK
4. Enjoy premium features!`;

const articleHtml = markdownToHtml(articleContent);
---

<!doctype html>
<html ⚡ lang="en">
<head>
  <meta charset="utf-8">
  <script async src="https://cdn.ampproject.org/v0.js"></script>
  <title>{seoTitle}</title>
  <link rel="canonical" href={canonicalUrl}>
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
  <meta name="description" content={seoDescription}>
  
  <!-- AMP Boilerplate -->
  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
  
  <!-- Custom AMP CSS -->
  <style amp-custom>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 40px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
    }
    
    .app-icon {
      width: 120px;
      height: 120px;
      border-radius: 24px;
      margin: 0 auto 20px;
      display: block;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .app-title {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 0 0 10px;
      line-height: 1.2;
    }
    
    .app-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin: 0 0 20px;
    }
    
    .rating {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .stars {
      display: flex;
      gap: 2px;
    }
    
    .star {
      width: 20px;
      height: 20px;
      fill: #fbbf24;
    }
    
    .download-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #000;
      color: white;
      padding: 16px 32px;
      border-radius: 16px;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1rem;
      margin: 20px 0;
      transition: all 0.2s ease;
    }
    
    .download-btn:hover {
      background: #333;
      transform: translateY(-2px);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }
    
    .info-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    
    .info-icon {
      width: 48px;
      height: 48px;
      background: #f3f4f6;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
    }
    
    .info-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 4px;
    }
    
    .info-value {
      font-size: 1.125rem;
      font-weight: bold;
      color: #111827;
      margin: 0;
    }
    
    .content-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      padding: 40px;
      margin: 40px 0;
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #111827;
      margin: 0 0 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .features-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .features-list li {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .features-list li:last-child {
      border-bottom: none;
    }
    
    .check-icon {
      width: 20px;
      height: 20px;
      fill: #10b981;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .related-apps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .related-app {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s ease;
    }
    
    .related-app:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
    }
    
    .related-app-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      margin: 0 auto 12px;
      display: block;
    }
    
    .related-app-name {
      font-weight: bold;
      margin: 0 0 4px;
      text-align: center;
    }
    
    .related-app-category {
      font-size: 0.875rem;
      color: #6b7280;
      text-align: center;
      margin: 0;
    }
    
    .breadcrumb {
      background: #f9fafb;
      padding: 12px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .breadcrumb a {
      color: #6b7280;
      text-decoration: none;
      font-size: 0.875rem;
    }
    
    .breadcrumb a:hover {
      color: #3b82f6;
    }
    
    .breadcrumb-separator {
      margin: 0 8px;
      color: #9ca3af;
    }
    
    @media (max-width: 768px) {
      .app-title {
        font-size: 2rem;
      }
      
      .info-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .content-section {
        padding: 20px;
      }
    }
  </style>
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "{app.name}",
    "applicationCategory": "MobileApplication",
    "operatingSystem": "Android",
    "softwareVersion": "{app.version}",
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": {app.rating},
      "ratingCount": {app.votes}
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>
</head>

<body>
  <div class="container">
    
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a href="/">Home</a>
      <span class="breadcrumb-separator">›</span>
      <a href="/apps">Apps</a>
      <span class="breadcrumb-separator">›</span>
      <a href={`/categories/${app.category.toLowerCase()}`}>{app.category}</a>
      <span class="breadcrumb-separator">›</span>
      <span>{app.name}</span>
    </nav>

    <!-- App Header -->
    <header class="header">
      {app.icon && (
        <amp-img
          src={app.icon}
          alt={`${app.name} icon`}
          width="120"
          height="120"
          class="app-icon"
        ></amp-img>
      )}
      
      <h1 class="app-title">{app.name} v{app.version} MOD APK</h1>
      {app.mod_info && app.mod_info.length > 0 && (
        <p class="app-subtitle">{app.mod_info[0]}</p>
      )}
      
      <div class="rating">
        <div class="stars">
          {[1,2,3,4,5].map(star => (
            <svg class={`star ${star <= Math.floor(app.rating) ? 'active' : ''}`} viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
          ))}
        </div>
        <span>{app.rating} ({app.votes.toLocaleString()} votes)</span>
      </div>
      
      <a href={app.download_url || '#'} class="download-btn">
        <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
        </svg>
        Download Now
      </a>
    </header>

    <!-- App Info -->
    <div class="info-grid">
      <div class="info-card">
        <div class="info-icon">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
          </svg>
        </div>
        <p class="info-label">Version</p>
        <p class="info-value">v{app.version}</p>
      </div>
      
      <div class="info-card">
        <div class="info-icon">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
          </svg>
        </div>
        <p class="info-label">Size</p>
        <p class="info-value">{app.size}</p>
      </div>
      
      <div class="info-card">
        <div class="info-icon">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
          </svg>
        </div>
        <p class="info-label">Publisher</p>
        <p class="info-value">{app.publisher}</p>
      </div>
      
      <div class="info-card">
        <div class="info-icon">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>
        <p class="info-label">Requirements</p>
        <p class="info-value">{app.requirements}</p>
      </div>
    </div>

    <!-- App Description -->
    <section class="content-section">
      <h2 class="section-title">About {app.name}</h2>
      <div set:html={articleHtml}></div>
    </section>

    <!-- Features -->
    {app.features && app.features.length > 0 && (
      <section class="content-section">
        <h2 class="section-title">Key Features</h2>
        <ul class="features-list">
          {app.features.map(feature => (
            <li>
              <svg class="check-icon" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              {feature}
            </li>
          ))}
        </ul>
      </section>
    )}

    <!-- MOD Info -->
    {app.mod_info && app.mod_info.length > 0 && (
      <section class="content-section">
        <h2 class="section-title">MOD Information</h2>
        <ul class="features-list">
          {app.mod_info.map(info => (
            <li>
              <svg class="check-icon" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              {info}
            </li>
          ))}
        </ul>
      </section>
    )}

    <!-- Related Apps -->
    {relatedApps.length > 0 && (
      <section class="content-section">
        <h2 class="section-title">Related Apps</h2>
        <div class="related-apps">
          {relatedApps.map(relatedApp => (
            <a href={`/${relatedApp.slug}`} class="related-app">
              {relatedApp.icon && (
                <amp-img
                  src={relatedApp.icon}
                  alt={`${relatedApp.name} icon`}
                  width="60"
                  height="60"
                  class="related-app-icon"
                ></amp-img>
              )}
              <h3 class="related-app-name">{relatedApp.name}</h3>
              <p class="related-app-category">{relatedApp.category}</p>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Footer -->
    <footer class="content-section">
      <p style="text-align: center; color: #6b7280; margin: 0;">
        © 2025 DexAPK. All rights reserved. | 
        <a href="/" style="color: #3b82f6;">Home</a> | 
        <a href="/apps" style="color: #3b82f6;">All Apps</a>
      </p>
    </footer>

  </div>
</body>
</html>