---
export const prerender = true;

import AMPLayout from '../../layouts/AMPLayout.astro';
import { getAllApps, getRelatedApps } from '../../lib/supabase.js';

export async function getStaticPaths() {
  try {
    const apps = await getAllApps();
    return apps.map(app => ({
      params: { slug: app.slug },
      props: { app }
    }));
  } catch (error) {
    console.error('Error generating static paths for AMP pages:', error);
    return [];
  }
}

const { slug } = Astro.params;
const { app } = Astro.props;

// If app not found, return 404
if (!app) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

// Get related apps
let relatedApps = [];
try {
  relatedApps = await getRelatedApps(app.slug, app.category, 3);
} catch (error) {
  console.error('Error loading related apps for AMP:', error);
}

// AMP-specific meta data
const ampTitle = `${app.name} v${app.version} MOD APK - Premium Features Unlocked`;
const ampDescription = `Download ${app.name} MOD APK v${app.version} with premium features unlocked. ${app.description.substring(0, 150)}...`;
const canonicalUrl = `https://dexapk.com/${app.slug}`;
const ampUrl = `https://dexapk.com/${app.slug}/amp`;
---

<AMPLayout 
  title={ampTitle}
  description={ampDescription}
  canonicalUrl={canonicalUrl}
  ampUrl={ampUrl}
  featuredImage={app.icon}
>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="app-icon">
        {app.icon ? (
          <amp-img 
            src={app.icon} 
            alt={`${app.name} icon`}
            width="96" 
            height="96"
            layout="fixed"
          ></amp-img>
        ) : (
          <svg width="48" height="48" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
          </svg>
        )}
      </div>
      
      <h1 class="app-title">{app.name}</h1>
      <p class="app-version">Version {app.version} • {app.size}</p>
      
      <!-- Rating -->
      <div class="rating">
        {[1,2,3,4,5].map(star => (
          <svg class={`star ${star <= Math.floor(app.rating) ? 'filled' : 'empty'}`} fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
        ))}
        <span class="rating-text">{app.rating} ({app.votes.toLocaleString()} votes)</span>
      </div>
      
      <!-- Download Button -->
      <a href={app.download_url || '#'} class="download-btn">
        Download MOD APK
      </a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    
    <!-- App Information -->
    <div class="card">
      <h2 class="card-title">App Information</h2>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Category</div>
          <div class="info-value">{app.category}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Publisher</div>
          <div class="info-value">{app.publisher}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Requirements</div>
          <div class="info-value">{app.requirements}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Last Updated</div>
          <div class="info-value">{app.last_updated}</div>
        </div>
      </div>
    </div>

    <!-- Description -->
    <div class="card">
      <h2 class="card-title">Description</h2>
      <p>{app.description}</p>
    </div>

    <!-- Features -->
    {app.features && app.features.length > 0 && (
      <div class="card">
        <h2 class="card-title">Features</h2>
        <ul class="feature-list">
          {app.features.map(feature => (
            <li class="feature-item">
              <div class="feature-icon"></div>
              <span>{feature}</span>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- MOD Info -->
    {app.mod_info && app.mod_info.length > 0 && (
      <div class="card">
        <h2 class="card-title">MOD Features</h2>
        <ul class="feature-list">
          {app.mod_info.map(info => (
            <li class="feature-item">
              <div class="feature-icon"></div>
              <span>{info}</span>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Screenshots -->
    {app.screenshots && app.screenshots.length > 0 && (
      <div class="card">
        <h2 class="card-title">Screenshots</h2>
        <div class="screenshots">
          <amp-carousel width="400" height="300" layout="responsive" type="slides">
            {app.screenshots.map((screenshot, index) => (
              <amp-img 
                src={screenshot} 
                alt={`${app.name} screenshot ${index + 1}`}
                width="400" 
                height="300"
                layout="responsive"
              ></amp-img>
            ))}
          </amp-carousel>
        </div>
      </div>
    )}

    <!-- Related Apps -->
    {relatedApps.length > 0 && (
      <div class="card">
        <h2 class="card-title">Related Apps</h2>
        <div class="related-apps">
          {relatedApps.map(relatedApp => (
            <a href={`/${relatedApp.slug}/amp`} class="related-app">
              {relatedApp.icon && (
                <amp-img 
                  src={relatedApp.icon} 
                  alt={`${relatedApp.name} icon`}
                  width="48" 
                  height="48"
                  layout="fixed"
                ></amp-img>
              )}
              <div class="related-app-title">{relatedApp.name}</div>
              <div class="related-app-category">{relatedApp.category}</div>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Download Section -->
    <div class="card">
      <h2 class="card-title">Download {app.name} MOD APK</h2>
      <p>Get the latest version with premium features unlocked</p>
      <a href={app.download_url || '#'} class="download-btn">
        Download v{app.version}
      </a>
    </div>

  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 DexAPK. All rights reserved.</p>
      <p>
        <a href="/" class="footer-link">Home</a> • 
        <a href="/apps" class="footer-link">All Apps</a> • 
        <a href="/about" class="footer-link">About</a> • 
        <a href="/contact" class="footer-link">Contact</a>
      </p>
      <p>
        <a href={canonicalUrl} class="footer-link">View Full Version</a>
      </p>
    </div>
  </footer>
</AMPLayout>