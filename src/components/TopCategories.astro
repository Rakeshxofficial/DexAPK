---
// Top Categories Component - Shows popular app categories
import { getAllApps } from '../lib/supabase.js';

export interface Props {
  maxCategories?: number;
  showHeading?: boolean;
  headingText?: string;
  currentCategory?: string;
}

const { 
  maxCategories = 6,
  showHeading = true,
  headingText = "Top Categories",
  currentCategory = ''
} = Astro.props;

// Get all apps to calculate category statistics
let categoryStats = {};
try {
  const allApps = await getAllApps();
  
  // Calculate stats for each category
  allApps.forEach(app => {
    if (!categoryStats[app.category]) {
      categoryStats[app.category] = {
        name: app.category,
        count: 0,
        totalRating: 0,
        totalVotes: 0,
        apps: []
      };
    }
    categoryStats[app.category].count++;
    categoryStats[app.category].totalRating += app.rating;
    categoryStats[app.category].totalVotes += app.votes;
    categoryStats[app.category].apps.push(app);
  });
  
  // Calculate averages and sort by popularity
  Object.keys(categoryStats).forEach(category => {
    const stats = categoryStats[category];
    stats.averageRating = stats.totalRating / stats.count;
    stats.popularityScore = (stats.averageRating * stats.totalVotes) + (stats.count * 10);
  });
  
} catch (error) {
  console.error('Error loading apps for category stats:', error);
  categoryStats = {};
}

// Convert to array and sort by popularity
const topCategories = Object.values(categoryStats)
  .filter(category => category.name !== currentCategory) // Exclude current category
  .sort((a, b) => b.popularityScore - a.popularityScore)
  .slice(0, maxCategories);

// Category metadata for styling and descriptions
const categoryMeta = {
  'Productivity': {
    description: 'Boost your efficiency with powerful productivity apps',
    gradient: 'from-gray-500 to-gray-700',
    icon: 'productivity',
    color: 'text-gray-600 dark:text-gray-400'
  },
  'Music': {
    description: 'Premium music streaming and audio editing apps',
    gradient: 'from-purple-500 to-pink-600',
    icon: 'music',
    color: 'text-purple-600 dark:text-purple-400'
  },
  'Video': {
    description: 'Professional video editing and streaming apps',
    gradient: 'from-red-500 to-orange-600',
    icon: 'video',
    color: 'text-red-600 dark:text-red-400'
  },
  'Entertainment': {
    description: 'Movies, TV shows, and entertainment content',
    gradient: 'from-indigo-500 to-purple-600',
    icon: 'entertainment',
    color: 'text-indigo-600 dark:text-indigo-400'
  },
  'Social': {
    description: 'Connect and share with social networking apps',
    gradient: 'from-blue-500 to-cyan-600',
    icon: 'social',
    color: 'text-blue-600 dark:text-blue-400'
  },
  'Photography': {
    description: 'Professional photo editing and camera apps',
    gradient: 'from-teal-500 to-green-600',
    icon: 'photography',
    color: 'text-teal-600 dark:text-teal-400'
  },
  'Games': {
    description: 'Unlimited resources and unlocked game features',
    gradient: 'from-green-500 to-blue-600',
    icon: 'games',
    color: 'text-green-600 dark:text-green-400'
  },
  'Media': {
    description: 'Media players and content management apps',
    gradient: 'from-orange-500 to-red-600',
    icon: 'media',
    color: 'text-orange-600 dark:text-orange-400'
  },
  'Apps': {
    description: 'General utility and lifestyle applications',
    gradient: 'from-blue-500 to-purple-600',
    icon: 'apps',
    color: 'text-blue-600 dark:text-blue-400'
  }
};

// Function to get category slug
function getCategorySlug(categoryName) {
  return categoryName.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}
---

{topCategories.length > 0 && (
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
    {showHeading && (
      <div class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
        <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
        {headingText}
      </div>
    )}
    
    <div class="space-y-3">
      {topCategories.map((category, index) => {
        const meta = categoryMeta[category.name] || categoryMeta['Apps'];
        const categorySlug = getCategorySlug(category.name);
        
        return (
          <article class="group">
            <a 
              href={`/categories/${categorySlug}`} 
              class="flex items-center p-4 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 border border-gray-100 dark:border-gray-600 hover:border-purple-300 dark:hover:border-purple-600"
            >
              
              <!-- Category Icon -->
              <div class={`w-12 h-12 bg-gradient-to-r ${meta.gradient} rounded-xl flex items-center justify-center mr-4 flex-shrink-0 group-hover:scale-110 transition-transform duration-200`}>
                <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  {meta.icon === 'productivity' && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h2m0 0h2m-2 0v4a2 2 0 002 2h2a2 2 0 002-2v-4m0 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v0"/>
                  )}
                  {meta.icon === 'music' && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                  )}
                  {meta.icon === 'video' && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                  )}
                  {meta.icon === 'entertainment' && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V1a1 1 0 011-1h2a1 1 0 011 1v18a1 1 0 01-1 1H4a1 1 0 01-1-1V1a1 1 0 011-1h2a1 1 0 011 1v3"/>
                  )}
                  {meta.icon === 'social' && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                  )}
                  {meta.icon === 'photography' && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                  )}
                  {meta.icon === 'games' && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                  )}
                  {(meta.icon === 'media' || meta.icon === 'apps') && (
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                  )}
                </svg>
              </div>
              
              <!-- Category Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-base font-semibold text-gray-900 dark:text-white group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors duration-200 truncate">
                    {category.name}
                  </h3>
                  <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-600 px-2.5 py-1 rounded-full flex-shrink-0 ml-3">
                    #{index + 1}
                  </span>
                </div>
                
                <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 mb-2">
                  <div class="flex items-center gap-2">
                    <span class="truncate">{category.count} apps</span>
                    <span>â€¢</span>
                    <div class="flex items-center gap-1">
                      <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                      <span class="text-sm font-medium">{category.averageRating}</span>
                    </div>
                  </div>
                </div>
                
                <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 leading-relaxed">
                  {meta.description}
                </p>
              </div>
              
              <!-- Arrow Icon -->
              <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 dark:group-hover:text-purple-400 group-hover:translate-x-1 transition-all duration-200 flex-shrink-0 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
              </svg>
            </a>
          </article>
        );
      })}
      
      <!-- View All Categories Link -->
      <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
        <a 
          href="/categories" 
          class="flex items-center justify-center w-full p-3 text-sm font-medium text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-xl transition-colors duration-200"
        >
          <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
          View All Categories
          <svg class="w-4 h-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
          </svg>
        </a>
      </div>
    </div>
  </div>
)}

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
    hyphens: auto;
  }
  
  /* Ensure minimum touch target sizes */
  a, button {
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Improved focus styles */
  a:focus, button:focus {
    outline: 2px solid #a855f7;
    outline-offset: 2px;
  }
  
  /* Ensure proper text wrapping and overflow handling */
  .category-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }
  
  /* Mobile-specific adjustments */
  @media (max-width: 640px) {
    .line-clamp-2 {
      -webkit-line-clamp: 1;
      line-height: 1.3;
    }
    
    /* Adjust spacing for mobile */
    .category-item {
      padding: 0.75rem;
    }
  }
  
  .bg-white.dark\\:bg-gray-800.rounded-2xl {
    contain: layout;
    overflow: hidden;
  }
  
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }
  
  /* Ensure proper text wrapping and prevent overflow */
  .category-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    max-width: 100%;
  }
</style>