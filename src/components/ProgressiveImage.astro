---
// Progressive Image component with beautiful blur-up effect
export interface Props {
  src: string;
  alt: string;
  width?: string | number;
  height?: string | number;
  class?: string;
  placeholderSize?: number;
}

const { 
  src, 
  alt, 
  width, 
  height, 
  class: className = "", 
  placeholderSize = 10 
} = Astro.props;

// Generate unique ID for this image
const id = `progressive-img-${Math.random().toString(36).substring(2, 11)}`;
---

<div class={`progressive-image-container ${className}`}>
  <!-- Main image (hidden until loaded) -->
  <img 
    id={id}
    src={src} 
    alt={alt}
    class="progressive-image-main" 
    width={width} 
    height={height}
    loading="lazy"
    onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23888\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3E%3Crect x=\'3\' y=\'3\' width=\'18\' height=\'18\' rx=\'2\' ry=\'2\'%3E%3C/rect%3E%3Ccircle cx=\'8.5\' cy=\'8.5\' r=\'1.5\'%3E%3C/circle%3E%3Cpolyline points=\'21 15 16 10 5 21\'%3E%3C/polyline%3E%3C/svg%3E';"
  />
  
  <!-- Fallback for no-JS environments -->
  <noscript>
    <img 
      src={src} 
      alt={alt}
      width={width} 
      height={height}
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
    />
  </noscript>
</div>

<script define:vars={{ id }}>
  // This script handles the image loading and transition
  document.addEventListener('DOMContentLoaded', function() {
    const img = document.getElementById(id);
    
    if (img) {
      // Add load event handler
      img.addEventListener('load', function() {
        // When image loads, fade it in
        img.style.opacity = '1';
      });
    }
  });
</script>

<style>
.progressive-image-container {
  position: relative;
  overflow: hidden;
  background-color: #f0f0f0;
  width: 100%;
  height: 100%;
  border-radius: inherit;
}

.progressive-image-main {
  position: relative;
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity 0.3s ease-in;
  will-change: opacity;
}

/* Dark mode support */
:global(.dark) .progressive-image-container {
  background-color: #2a2a2a;
}

/* Reduced motion preference support */
@media (prefers-reduced-motion: reduce) {
  .progressive-image-main {
    transition: none !important;
  }
}
</style>